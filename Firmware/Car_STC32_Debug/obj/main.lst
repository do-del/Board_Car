C251 COMPILER V5.60.0,  main                                                               19/06/23  16:47:43  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\obj\main.obj
COMPILER INVOKED BY: C:\Keil_c251\C251\BIN\C251.EXE src\main.c XSMALL INTR2 BROWSE INCDIR(.\Del;.\src) DEBUG PRINT(.\obj
                    -\main.lst) TABS(2) OBJECT(.\obj\main.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- STC MCU Limited ------------------------------------------------*/
    3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
    4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
    5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
    6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
    7          /* --- Web: www.STCMCU.com --------------------------------------------*/
    8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
    9          /* --- QQ:  800003751 -------------------------------------------------*/
   10          /* Èç¹ûÒªÔÚ³ÌĞòÖĞÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌĞòÖĞ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌĞò        */
   11          /*---------------------------------------------------------------------*/
   12          
   13          /*************  ¹¦ÄÜËµÃ÷    **************
   14          
   15          ±¾Àı³Ì»ùÓÚSTC32GºËĞÄ×ª½Ó°å£¨ÍÀÁúµ¶£©½øĞĞ±àĞ´²âÊÔ¡£
   16          
   17          Ê¹ÓÃUSBÏßÁ¬½ÓºËĞÄ°åUSB½Ó¿ÚÓëµçÄÔ;
   18          
   19          MCUÍ¨¹ıUSB CDC(Communication Device Class)Ğ­ÒéÊ¶±ğÎª´®¿ÚÉè±¸;
   20          
   21          Ê¹ÓÃ´®¿ÚÖúÊÖ´ò¿ªCDCĞéÄâ´®¿Ú£¬È»ºóÏòMCU·¢ËÍÊı¾İ£¬MCU·µ»Ø½ÓÊÕµ½µÄÊı¾İµ½´®¿ÚÖúÊÖ;
   22          
   23          Êı¾İ³¤¶ÈÏŞÖÆÔÚ63×Ö½ÚÒÔÄÚ¡£
   24          
   25          ´ËÍâ³ÌĞòÑİÊ¾Á½ÖÖ¸´Î»½øÈëUSBÏÂÔØÄ£Ê½µÄ·½·¨£º
   26          1. Í¨¹ıÃ¿1ºÁÃëÖ´ĞĞÒ»´Î¡°KeyResetScan¡±º¯Êı£¬ÊµÏÖ³¤°´P3.2¿Ú°´¼ü´¥·¢MCU¸´Î»£¬½øÈëUSBÏÂÔØÄ£Ê½¡£
   27             (Èç¹û²»Ï£Íû¸´Î»½øÈëUSBÏÂÔØÄ£Ê½µÄ»°£¬¿ÉÔÚ¸´Î»´úÂëÀï½« IAP_CONTR µÄbit6Çå0£¬Ñ¡Ôñ¸´Î»½øÓÃ»§³ÌĞòÇø)
   28          2. Í¨¹ı¼ÓÔØ¡°stc_usb_cdc_32g.lib¡±¿âº¯Êı£¬ÊµÏÖÊ¹ÓÃSTC-ISPÈí¼ş·¢ËÍÖ¸Áî´¥·¢MCU¸´Î»£¬½øÈëUSBÏÂÔØÄ£Ê½²¢×Ô¶¯ÏÂ
             -ÔØ¡£
   29             (×¢Òâ£ºÊ¹ÓÃCDC½Ó¿Ú´¥·¢MCU¸´Î»²¢×Ô¶¯ÏÂÔØ¹¦ÄÜ£¬ĞèÒª¹´Ñ¡¶Ë¿ÚÉèÖÃ£ºÏÂ´ÎÇ¿ÖÆÊ¹ÓÃ¡±STC USB Writer (HID)¡±½øĞ
             -ĞISPÏÂÔØ)
   30          
   31          ÏÂÔØÊ±, Ñ¡ÔñÊ±ÖÓ 24MHZ (ÓÃ»§¿É×ÔĞĞĞŞ¸ÄÆµÂÊ)¡£
   32          
   33          ******************************************/
   34          
   35          #include "stc.h"
   36          #include "usb.h"
   37          #include "debug.h"
   38          #include "led.h"
   39          #include "i2c.h"
   40          #include "mpu6050.h"
   41          #include "pwm.h"
   42          #include "rf24.h"
   43          #include "timer.h"
   44          
   45          #define MAIN_Fosc       24000000L   //¶¨ÒåÖ÷Ê±ÖÓ
   46          
   47          char *USER_DEVICEDESC = NULL;
   48          char *USER_PRODUCTDESC = NULL;
   49          char *USER_STCISPCMD = "@STCISP#";                      //ÉèÖÃ×Ô¶¯¸´Î»µ½ISPÇøµÄÓÃ»§½Ó¿ÚÃüÁî
   50          
   51          //P3.2¿Ú°´¼ü¸´Î»ËùĞè±äÁ¿
   52          bit Key_Flag;
   53          u16 Key_cnt;
   54          
   55          bit rx_flag = 1;
   56          unsigned char rx[11] = {0};
C251 COMPILER V5.60.0,  main                                                               19/06/23  16:47:43  PAGE 2   

   57          unsigned char tx[11] = {'O','K',0};
   58          
   59          mpu6050_struct mpu_dat;
   60          
   61          void sys_init();
   62          void delay_ms(u8 ms);
   63          void KeyResetScan(void);
   64          
   65          void I2C_Scan(void)
   66          {
   67   1      #if DEBUG_ENABLE
   68   1        unsigned char addr_test;
   69   1        unsigned char flag = 0;
   70   1        
   71   1        printf("i2c scan start...\r\n");
   72   1        
   73   1        for(addr_test = 0; addr_test < 200; addr_test++)
   74   1        {
   75   2          I2C_Start();
   76   2          if(!I2C_SendByte(addr_test<<1)) flag = 1;
   77   2          I2C_Stop();
   78   2          if(flag)
   79   2          {
   80   3            flag = 0;
   81   3            printf("Find addr: %X\r\n", addr_test);
   82   3          }
   83   2        }
   84   1        
   85   1        printf("i2c scan done\r\n");
   86   1        
   87   1      #endif
   88   1      }
   89          
   90          void update_1ms(void)
   91          {
   92   1        if(rx_flag)
   93   1        {
   94   2          if(RF24_IRQ == 0)
   95   2          {
   96   3            //uint8_t i;
   97   3            RF24_Read_Buf(RD_RX_PLOAD,rx,11);     //¶ÁÈ¡Êı¾İ
   98   3            CE_LOW();
   99   3            RF24_Write_Reg(WRITE_REG+STATUS,0x40);
  100   3            CE_HIGH();
  101   3            
  102   3            /*
  103   3            for(i = 0;i<11;i++)
  104   3            {
  105   3              Uart_Send(rx[i]);
  106   3            }
  107   3            */
  108   3            printf("rx:%c\r\n", rx[0]);
  109   3            if(rx[0] == 'D')
  110   3            {
  111   4              /*
  112   4              PWM_Set_Duty(CH_0,(uint16_t)(rx[1]<<3)+500);
  113   4              PWM_Set_Duty(CH_1,(uint16_t)(rx[2]<<3)+500);
  114   4              PWM_Set_Duty(CH_2,(uint16_t)(rx[3]<<3)+500);
  115   4              PWM_Set_Duty(CH_3,(uint16_t)(rx[4]<<3)+500);
  116   4              CH9 = rx[5];
  117   4              CH10 = rx[6];
  118   4              */
  119   4            }
  120   3            rx_flag = 0;
  121   3            RF24_TX_Mode();
  122   3          }
C251 COMPILER V5.60.0,  main                                                               19/06/23  16:47:43  PAGE 3   

  123   2        }
  124   1        else
  125   1        {
  126   2          CE_LOW();
  127   2          RF24_Write_Buf(WR_TX_PLOAD, tx, 11);
  128   2          CE_HIGH();
  129   2          delay_ms(1);
  130   2          rx_flag = 1;
  131   2          RF24_RX_Mode();
  132   2        }
  133   1      }
  134          
  135          void main()
  136          {
  137   1        sys_init();  //ÏµÍ³³õÊ¼»¯
  138   1        usb_init();  //USB CDC ½Ó¿ÚÅäÖÃ
  139   1        EA = 1;
  140   1        
  141   1        while(DeviceState != DEVSTATE_CONFIGURED); //µÈ´ıUSBÍê³ÉÅäÖÃ
  142   1        
  143   1        P20 = 0;
  144   1        P21= 0;
  145   1        P3PU |= 0x08;
  146   1        delay_ms(200);
  147   1        delay_ms(200);
  148   1        delay_ms(200);
  149   1        delay_ms(200);
  150   1        delay_ms(200);
  151   1        P21 = 1;
  152   1        printf("---------STC32 Debug----------\r\n");
  153   1        //I2C_Scan();
  154   1        //mpu6050_init();
  155   1        
  156   1        //PWM³õÊ¼»¯
  157   1        pwm_init();
  158   1        pwma_setcycle(1000);
  159   1        pwm1_setduty(300);
  160   1        pwm4_setduty(300);
  161   1        pwm1p_enable();
  162   1        pwm4p_enable();
  163   1        pwm1n_enable();
  164   1        pwm4n_enable();
  165   1        
  166   1        //RF24³õÊ¼»¯²¢½øÈëRXÄ£Ê½
  167   1        RF24_Init();
  168   1        RF24_Write_Reg(WRITE_REG + EN_AA,0x00);
  169   1        RF24_Write_Reg(WRITE_REG+EN_RXADDR,0x01);
  170   1        RF24_Write_Reg(WRITE_REG+SETUP_RETR,0x00);
  171   1        RF24_RX_Mode();
  172   1        //RF24_TX_Mode();
  173   1        RF24_Set_Channel(66);
  174   1        RF24_Set_Power(RF_PWR_0);
  175   1        RF24_Set_P0_Size(11);
  176   1        RF24_Set_Rate(RATE_1M_BPS);
  177   1        RF24_Write_Buf(WRITE_REG + TX_ADDR, TX_ADDRESS, TX_ADR_WIDTH);     // Ğ´Èë·¢ËÍµØÖ·
  178   1        RF24_Write_Buf(WRITE_REG + RX_ADDR_P0, TX_ADDRESS, TX_ADR_WIDTH);  // ÎªÁËÓ¦´ğ½ÓÊÕÉè±¸£¬½ÓÊÕÍ¨µÀ0µØÖ·ºÍ·
             -¢ËÍµØÖ·ÏàÍ¬
  179   1        rx_flag = 1;
  180   1        
  181   1        P20 = 1;
  182   1        
  183   1        while (1)
  184   1        {
  185   2          delay_ms(1);
  186   2          KeyResetScan();   //³¤°´P3.2¿Ú°´¼ü´¥·¢Èí¼ş¸´Î»£¬½øÈëUSBÏÂÔØÄ£Ê½£¬²»ĞèÒª´Ë¹¦ÄÜ¿ÉÉ¾³ı±¾ĞĞ´úÂë
  187   2          
C251 COMPILER V5.60.0,  main                                                               19/06/23  16:47:43  PAGE 4   

  188   2          if(DeviceState != DEVSTATE_CONFIGURED)  //µÈ´ıUSBÍê³ÉÅäÖÃ
  189   2            continue;
  190   2      
  191   2          if (bUsbOutReady)
  192   2          {
  193   3            usb_OUT_done();    //½ÓÊÕÓ¦´ğ£¨¹Ì¶¨¸ñÊ½£©
  194   3            
  195   3            printf("OutNumber=0x%X\r\n",OutNumber);  //Ê¹ÓÃ printf º¯Êı´òÓ¡½ÓÊÕÊı¾İ³¤¶È
  196   3      
  197   3            memcpy(UsbInBuffer, UsbOutBuffer, OutNumber);  //½«½ÓÊÕÊı¾İ(UsbOutBuffer)£¬¸´ÖÆµ½·¢ËÍ»º³åÇø(UsbInBuffe
             -r)
  198   3            usb_IN(OutNumber);      //Ô­Â··µ»Ø, ÓÃÓÚ²âÊÔ
  199   3          }
  200   2        }
  201   1      }
  202          
  203          void sys_init()
  204          {
  205   1        WTST = 0;  //ÉèÖÃ³ÌĞòÖ¸ÁîÑÓÊ±²ÎÊı£¬¸³ÖµÎª0¿É½«CPUÖ´ĞĞÖ¸ÁîµÄËÙ¶ÈÉèÖÃÎª×î¿ì
  206   1        EAXFR = 1; //À©Õ¹¼Ä´æÆ÷(XFR)·ÃÎÊÊ¹ÄÜ
  207   1        CKCON = 0; //Ìá¸ß·ÃÎÊXRAMËÙ¶È
  208   1      
  209   1        P0M1 = 0x00;   P0M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  210   1        P1M1 = 0x00;   P1M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  211   1        P2M1 = 0x00;   P2M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  212   1        P3M1 = 0x00;   P3M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  213   1        P4M1 = 0x00;   P4M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  214   1        P5M1 = 0x00;   P5M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  215   1        P6M1 = 0x00;   P6M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  216   1        P7M1 = 0x00;   P7M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
  217   1        
  218   1        Debug_Init(); //µ÷ÊÔ¿Ú³õÊ¼»¯
  219   1        
  220   1        I2C_Init();
  221   1        
  222   1        timer0_init(1000, update_1ms);
  223   1      }
  224          
  225          //========================================================================
  226          // º¯Êı: void delay_ms(u8 ms)
  227          // ÃèÊö: ÑÓÊ±º¯Êı¡£
  228          // ²ÎÊı: ms,ÒªÑÓÊ±µÄmsÊı, ÕâÀïÖ»Ö§³Ö1~255ms. ×Ô¶¯ÊÊÓ¦Ö÷Ê±ÖÓ.
  229          // ·µ»Ø: none.
  230          // °æ±¾: VER1.0
  231          // ÈÕÆÚ: 2021-3-9
  232          // ±¸×¢: 
  233          //========================================================================
  234          void delay_ms(u8 ms)
  235          {
  236   1           u16 i;
  237   1           do{
  238   2                i = MAIN_Fosc / 6000;
  239   2                while(--i);   //6T per loop
  240   2           }while(--ms);
  241   1      }
  242          
  243          //========================================================================
  244          // º¯Êı: void KeyResetScan(void)
  245          // ÃèÊö: P3.2¿Ú°´¼ü³¤°´1Ãë´¥·¢Èí¼ş¸´Î»£¬½øÈëUSBÏÂÔØÄ£Ê½¡£
  246          // ²ÎÊı: none.
  247          // ·µ»Ø: none.
  248          // °æ±¾: VER1.0
  249          // ÈÕÆÚ: 2022-6-11
  250          // ±¸×¢: 
  251          //========================================================================
  252          void KeyResetScan(void)
C251 COMPILER V5.60.0,  main                                                               19/06/23  16:47:43  PAGE 5   

  253          {
  254   1          if(!P32)
  255   1          {
  256   2              if(!Key_Flag)
  257   2              {
  258   3                  Key_cnt++;
  259   3                  if(Key_cnt >= 1000)   //Á¬Ğø1000msÓĞĞ§°´¼ü¼ì²â
  260   3                  {
  261   4                      Key_Flag = 1;   //ÉèÖÃ°´¼ü×´Ì¬£¬·ÀÖ¹ÖØ¸´´¥·¢
  262   4      
  263   4                      USBCON = 0x00;      //Çå³ıUSBÉèÖÃ
  264   4                      USBCLK = 0x00;
  265   4                      IRC48MCR = 0x00;
  266   4                      
  267   4                      delay_ms(10);
  268   4                      IAP_CONTR = 0x60;   //´¥·¢Èí¼ş¸´Î»£¬´ÓISP¿ªÊ¼Ö´ĞĞ
  269   4                      while (1);
  270   4                  }
  271   3              }
  272   2          }
  273   1          else
  274   1          {
  275   2              Key_cnt = 0;
  276   2              Key_Flag = 0;
  277   2          }
  278   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       588     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        50     ------
  bit size             =         2     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       173     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
